# Documento de Requisitos del Sistema (DRS)

**Tarea 7: Esquema de Base de Datos**
**Proyecto:** Chatbot Inteligente con Procesamiento Paralelo para Ayudas Universitarias
**Versión:** 1.0

---

## 1. Introducción

Este documento presenta el **diseño de la base de datos** del chatbot universitario, incluyendo las entidades principales, sus atributos, tipos de datos y las relaciones entre ellas. La estructura está diseñada para soportar los requisitos funcionales y no funcionales definidos en las tareas previas, garantizando integridad, escalabilidad y seguridad de los datos.

El esquema se basa en un modelo relacional que permite gestionar eficientemente las interacciones del chatbot, usuarios, mensajes y base de conocimientos.

---

## 2. Análisis del Esquema de Base de Datos

![Esquema de Base de Datos - Chatbot Universitario](https://raw.githubusercontent.com/louisbarrera/ingSoftware2-actividades/refs/heads/main/primerCorte/imagenes/7.%20Esquema_de_base_de_datos.png)

### 2.1 Descripción General de las Entidades

El diagrama muestra **4 entidades principales** interconectadas que forman el núcleo del sistema:

**1. faqs (Base de Conocimientos)**
- Almacena las preguntas frecuentes y sus respuestas
- Incluye embeddings para procesamiento de lenguaje natural
- Control de estado activo/inactivo para gestión dinámica del contenido

**2. users (Usuarios del Sistema)**
- Gestiona la información de los usuarios que administran el sistema
- Incluye autenticación y control de roles
- Maneja datos personales con campos de contacto

**3. clients (Clientes/Usuarios Finales)**
- Registra a los usuarios finales que interactúan con el chatbot
- Vincula con hilos de conversación (thread_id)
- Control de estado del chatbot por cliente

**4. messages (Mensajes de Conversación)**
- Almacena todas las interacciones del chat
- Diferencia entre mensajes de usuario y respuestas del bot
- Incluye metadatos como WAMID para integración con WhatsApp

### 2.2 Especificación Detallada de Entidades

#### Tabla: faqs
| Campo       | Tipo          | Descripción                                          | Restricciones    |
|-------------|---------------|------------------------------------------------------|------------------|
| id          | uuid          | Identificador único de la pregunta frecuente        | PRIMARY KEY      |
| question    | text NN       | Pregunta en lenguaje natural                         | NOT NULL         |
| answer      | text          | Respuesta correspondiente a la pregunta              | -                |
| embedding   | jsonb         | Vector de embeddings para búsqueda semántica        | -                |
| is_active   | boolean NN    | Estado de la FAQ (activa/inactiva)                   | NOT NULL         |
| created_at  | timestamptz NN| Fecha y hora de creación                             | NOT NULL         |
| updated_at  | timestamptz NN| Fecha y hora de última actualización                 | NOT NULL         |

#### Tabla: users
| Campo       | Tipo          | Descripción                                          | Restricciones    |
|-------------|---------------|------------------------------------------------------|------------------|
| id          | uuid          | Identificador único del usuario administrador        | PRIMARY KEY      |
| cedula      | varchar(32) NN| Número de cédula del usuario                         | NOT NULL         |
| name        | varchar(255) NN| Nombre completo del usuario                          | NOT NULL         |
| email       | varchar(255) NN| Correo electrónico institucional                     | NOT NULL         |
| password    | varchar(255) NN| Contraseña encriptada                                | NOT NULL         |
| role        | user_role E NN| Rol del usuario en el sistema (admin, moderador)     | NOT NULL, ENUM   |
| is_active   | boolean NN    | Estado del usuario (activo/inactivo)                 | NOT NULL         |
| created_at  | timestamptz NN| Fecha y hora de creación de la cuenta                | NOT NULL         |
| updated_at  | timestamptz NN| Fecha y hora de última actualización                 | NOT NULL         |

#### Tabla: clients
| Campo           | Tipo          | Descripción                                          | Restricciones    |
|-----------------|---------------|------------------------------------------------------|------------------|
| id              | uuid          | Identificador único del cliente                      | PRIMARY KEY      |
| name            | varchar(255)  | Nombre del cliente (opcional)                        | -                |
| chatbot_is_active| boolean NN   | Estado del chatbot para este cliente                 | NOT NULL         |
| phone_number    | varchar(32) NN| Número de teléfono del cliente                       | NOT NULL         |
| thread_id       | varchar(128)  | Identificador del hilo de conversación               | -                |
| last_interaction| timestamptz   | Fecha y hora de la última interacción                | -                |
| created_at      | timestamptz NN| Fecha y hora de registro del cliente                 | NOT NULL         |
| updated_at      | timestamptz NN| Fecha y hora de última actualización                 | NOT NULL         |

#### Tabla: messages
| Campo       | Tipo          | Descripción                                          | Restricciones    |
|-------------|---------------|------------------------------------------------------|------------------|
| id          | uuid          | Identificador único del mensaje                      | PRIMARY KEY      |
| client_id   | uuid NN       | Referencia al cliente que envía/recibe el mensaje   | FOREIGN KEY, NN  |
| sender_type | sender_type E NN| Tipo de remitente (user/bot)                       | NOT NULL, ENUM   |
| type        | message_type E NN| Tipo de mensaje (text/image/audio)                 | NOT NULL, ENUM   |
| date        | timestamptz NN| Fecha y hora del mensaje                             | NOT NULL         |
| content     | jsonb NN      | Contenido del mensaje en formato JSON               | NOT NULL         |
| wamid       | varchar(128)  | ID único de WhatsApp para el mensaje                 | -                |
| created_at  | timestamptz NN| Fecha y hora de creación del registro                | NOT NULL         |
| updated_at  | timestamptz NN| Fecha y hora de última actualización                 | NOT NULL         |

### 2.3 Relaciones Entre Entidades

**clients ↔ messages (1:N)**
- Un cliente puede tener múltiples mensajes
- Cada mensaje pertenece a un único cliente
- **FK:** messages.client_id → clients.id

**Relaciones implícitas:**
- Los usuarios (users) administran las FAQs a través del sistema
- Los mensajes pueden referenciar respuestas de la base de conocimientos (faqs)

---

## 3. Validación con Requisitos

### 3.1 Cumplimiento de Requisitos de Información

| Requisito | Entidad/Campo Correspondiente | Validación |
|-----------|-------------------------------|------------|
| INF-01: Base de conocimientos | faqs (completa) | ✅ Cumple |
| INF-02: Interacciones de usuarios | messages + clients | ✅ Cumple |
| INF-03: Perfiles de usuarios | users + clients | ✅ Cumple |
| INF-04: Notificaciones y redirecciones | messages.content (JSON) | ✅ Cumple |
| INF-05: Métricas de rendimiento | messages + timestamps | ✅ Cumple |
| INF-06: Logs del sistema | Implementado via timestamps | ✅ Cumple |

### 3.2 Cumplimiento de Reglas de Negocio

| Regla | Implementación en BD | Estado |
|-------|---------------------|--------|
| REG-01: Unicidad de interacciones | UUID como PRIMARY KEY | ✅ |
| REG-02: Privacidad de usuarios | Separación users/clients | ✅ |
| REG-03: Retención de datos | Campos created_at/updated_at | ✅ |
| REG-04: Integridad de logs | Timestamps automáticos | ✅ |
| REG-05: Seguridad en almacenamiento | Password encriptado | ✅ |

---

## 4. Características Técnicas del Diseño

### 4.1 Escalabilidad
- **UUIDs**: Permiten distribución y réplicas de base de datos
- **Índices implícitos**: En campos de búsqueda frecuente (phone_number, thread_id)
- **JSON fields**: Flexibilidad para contenido variable sin cambios de esquema

### 4.2 Seguridad
- **Separación de concerns**: Users (admin) vs Clients (finales)
- **Encriptación**: Password field para usuarios administrativos
- **Audit trail**: Timestamps de creación y actualización en todas las tablas

### 4.3 Integración WhatsApp
- **WAMID field**: Compatibilidad nativa con API de WhatsApp
- **Thread management**: Control de hilos de conversación por cliente
- **JSON content**: Soporte para diferentes tipos de mensaje multimedia

---

## 5. Próximos Pasos de Implementación

* **Creación del esquema**: Implementar DDL en PostgreSQL con tipos ENUM
* **Índices de optimización**: Crear índices compuestos para consultas frecuentes
* **Migración de datos**: Scripts para poblar FAQs iniciales
* **Procedimientos almacenados**: Para operaciones complejas de búsqueda semántica
* **Backup y recovery**: Estrategias de respaldo automático

---

**Autores:** Luis Steven Barrera Rincón – Cristhian Javier Vera Villamizar
